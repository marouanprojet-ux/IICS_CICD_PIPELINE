name: DEV â†’ UAT Pipeline

on:
  workflow_dispatch:
  push:
    branches: [ dev ]

jobs:
  validate-dev:
    runs-on: ubuntu-latest
    outputs:
      hash: ${{ steps.commit.outputs.hash }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        repository: marouanprojet-ux/IICS_CICD_PIPELINE
        
    - uses: actions/checkout@v4
      with:
        repository: marouanprojet-ux/iic_demo
        ref: dev
        path: iic_demo
        
    - id: commit
      run: |
        cd iic_demo
        echo "hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        
    - uses: actions/setup-python@v5
      with:
        python-version: 3.9
        
    - run: pip install requests
    
    - id: auth
      env:
        IICS_USERNAME: ${{ secrets.IICS_USERNAME }}
        IICS_PASSWORD: ${{ secrets.IICS_PASSWORD }}
      run: python scripts/iics_auth.py
      
    - run: |
        echo "âœ… DEV Hash: ${{ steps.commit.outputs.hash }}"
        echo "ðŸŽ¯ Skip IDMC â†’ UAT READY"

  deploy-uat:
    name: ðŸš€ Deploy UAT
    needs: validate-dev
    runs-on: ubuntu-latest
    environment: uat
    
    steps:
    - uses: actions/checkout@v4
      
    - uses: actions/setup-python@v5
      with:
        python-version: 3.9
        
    - run: pip install requests
      
    - name: UAT Auth & Deploy
      env:
        COMMIT_HASH: ${{ needs.validate-dev.outputs.hash }}
        IICS_USERNAME: ${{ secrets.UAT_USERNAME }}
        IICS_PASSWORD: ${{ secrets.UAT_PASSWORD }}
        IICS_UAT_POD_URL: https://emw1.dm-em.informaticacloud.com/saas
      run: |
        echo "ðŸš€ UAT Deploy: $COMMIT_HASH"
        python scripts/deploy_uat.py
