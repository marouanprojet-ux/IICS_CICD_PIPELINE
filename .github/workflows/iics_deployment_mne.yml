name: IICS Deployment MNE

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      iic_ref:
        description: "Branch/tag du repo iic_demo (ex: dev, v1.2.0)"
        required: true
        default: "dev"
        type: string

env:
  IICS_LOGIN_URL: https://dm-em.informaticacloud.com
  IICS_POD_URL: https://dm-em.informaticacloud.com/saas

jobs:
  deploy_dev:
    name: Deploy DEV
    runs-on: ubuntu-latest

    steps:
      - name: Checkout pipeline repo
        uses: actions/checkout@v4
        with:
          repository: marouanprojet-ux/IICS_CICD_PIPELINE

      - name: Checkout iic_demo
        uses: actions/checkout@v4
        with:
          repository: marouanprojet-ux/iic_demo
          ref: ${{ github.event.inputs.iic_ref || 'dev' }}
          path: iic_demo
          fetch-depth: 1

      - name: Compute iic_demo commit hash
        run: |
          cd iic_demo
          echo "COMMIT_HASH=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "Commit selected: $(git rev-parse HEAD)"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: pip install requests

      - name: Authenticate to IICS (DEV)
        env:
          IICS_USERNAME: ${{ secrets.IICS_DEV_USERNAME }}
          IICS_PASSWORD: ${{ secrets.IICS_DEV_PASSWORD }}
          IICS_LOGIN_URL: ${{ env.IICS_LOGIN_URL }}
          IICS_POD_URL: ${{ env.IICS_POD_URL }}
        run: python scripts/iics_auth.py

      - name: Deploy DEV
        env:
          sessionId: ${{ env.sessionId }}
          # ✅ Ton deploy_dev.py actuel attend ces deux variables (d'après l'erreur)
          IICSPOD_URL: ${{ env.IICS_POD_URL }}
          COMMITHASH: ${{ env.COMMIT_HASH }}
        run: python scripts/deploy_dev.py
