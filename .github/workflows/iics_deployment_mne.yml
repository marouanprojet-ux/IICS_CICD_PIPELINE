name: IICS CICD - Deploy DEV to UAT

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch iic_demo √† d√©ployer'
        required: true
        default: 'dev'
        type: string

env:
  IICS_LOGIN_URL: https://dm-em.informaticacloud.com
  IICS_DEV_POD_URL: https://dm-em.informaticacloud.com/saas
  IICS_UAT_POD_URL: https://emw1.dm-em.informaticacloud.com/saas

jobs:
  # ========== JOB 1 : Validation DEV ==========
  validate_dev:
    name: Validate DEV (contr√¥le deploy)
    runs-on: ubuntu-latest
    outputs:
      commit_hash: ${{ steps.hash.outputs.hash }}
      
    steps:
      - name: Checkout Pipeline
        uses: actions/checkout@v4

      - name: Checkout iic_demo
        uses: actions/checkout@v4
        with:
          repository: marouanprojet-ux/iic_demo
          ref: ${{ github.event.inputs.branch || 'dev' }}
          path: iic_demo

      - name: Get commit hash
        id: hash
        run: |
          cd iic_demo
          HASH=$(git rev-parse HEAD)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "‚úÖ Commit: $HASH"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - run: pip install requests

      - name: Auth IICS DEV
        env:
          IICS_USERNAME: ${{ secrets.IICS_DEV_USERNAME }}
          IICS_PASSWORD: ${{ secrets.IICS_DEV_PASSWORD }}
          IICS_LOGIN_URL: ${{ env.IICS_LOGIN_URL }}
        run: python scripts/iics_auth.py

      # ‚úÖ CONTR√îLE : V√©rifier commit tag IDMC contient "deploy"
      - name: V√©rifier commit tag "deploy" dans IDMC
        env:
          sessionId: ${{ env.sessionId }}
          POD_URL: ${{ env.IICS_DEV_POD_URL }}
          COMMIT: ${{ steps.hash.outputs.hash }}
        run: |
          # R√©cup√©rer dernier commit IDMC
          RESP=$(curl -sS -X GET "$POD_URL/public/core/v3/sourceControlAction" \
            -H "INFA-SESSION-ID: $sessionId" \
            -H "Accept: application/json")
          
          # Extraire dernier commit tag
          TAG=$(echo "$RESP" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('items',[{}])[0].get('commitTag',''))")
          
          echo "üìå Dernier commit tag IDMC: $TAG"
          
          # V√©rifier "deploy" pr√©sent
          if [[ ! "$TAG" =~ deploy ]]; then
            echo "‚ùå ABORT: Commit tag doit contenir 'deploy'"
            echo "   Actuel: '$TAG'"
            exit 1
          fi
          
          echo "‚úÖ Tag OK: '$TAG' contient 'deploy'"

  # ========== JOB 2 : Deploy UAT ==========
  deploy_uat:
    name: Deploy to UAT
    needs: validate_dev
    runs-on: ubuntu-latest
    environment: UAT
    
    steps:
      - name: Checkout Pipeline
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - run: pip install requests

      - name: Auth IICS UAT
        env:
          IICS_USERNAME: ${{ secrets.IICS_UAT_USERNAME }}
          IICS_PASSWORD: ${{ secrets.IICS_UAT_PASSWORD }}
          IICS_LOGIN_URL: ${{ env.IICS_LOGIN_URL }}
        run: python scripts/iics_auth.py

      # Pull commit DEV ‚Üí UAT via API
      - name: Pull commit to UAT
        env:
          sessionId: ${{ env.sessionId }}
          POD_URL: ${{ env.IICS_UAT_POD_URL }}
          COMMIT_HASH: ${{ needs.validate_dev.outputs.commit_hash }}
        run: |
          echo "üöÄ Deploy commit $COMMIT_HASH vers UAT..."
          
          RESP=$(curl -sS -w "\n%{http_code}" -X POST "$POD_URL/public/core/v3/pullByCommitHash" \
            -H "INFA-SESSION-ID: $sessionId" \
            -H "Content-Type: application/json" \
            -d "{\"commitHash\":\"$COMMIT_HASH\"}")
          
          STATUS=$(echo "$RESP" | tail -n1)
          BODY=$(echo "$RESP" | head -n-1)
          
          if [[ "$STATUS" == "200" || "$STATUS" == "202" ]]; then
            echo "‚úÖ Pull lanc√© vers UAT"
            echo "$BODY"
          else
            echo "‚ùå Erreur pull UAT: $STATUS"
            echo "$BODY"
            exit 1
          fi

      - name: Success
        run: echo "üéâ Deploy DEV ‚Üí UAT termin√© !"
