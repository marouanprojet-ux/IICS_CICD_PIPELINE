name: IICS CICD - Deploy DEV to UAT

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      commit_hash:
        description: 'Commit hash IDMC √† d√©ployer (laissez vide = dernier commit dev)'
        required: false
        type: string
      branch:
        description: 'Branch iic_demo (si commit_hash vide)'
        required: false
        default: 'dev'
        type: string

env:
  IICS_LOGIN_URL: https://dm-em.informaticacloud.com
  IICS_DEV_POD_URL: https://dm-em.informaticacloud.com/saas
  IICS_UAT_POD_URL: https://emw1.dm-em.informaticacloud.com/saas

jobs:
  # ========== JOB 1 : Validation DEV ==========
  validate_dev:
    name: Validate DEV (contr√¥le deploy)
    runs-on: ubuntu-latest
    outputs:
      commit_hash: ${{ steps.get_hash.outputs.hash }}
      
    steps:
      - name: Checkout Pipeline
        uses: actions/checkout@v4

      - name: Checkout iic_demo
        if: ${{ github.event.inputs.commit_hash == '' }}
        uses: actions/checkout@v4
        with:
          repository: marouanprojet-ux/iic_demo
          ref: ${{ github.event.inputs.branch || 'dev' }}
          path: iic_demo

      - name: Get commit hash
        id: get_hash
        run: |
          if [ -n "${{ github.event.inputs.commit_hash }}" ]; then
            HASH="${{ github.event.inputs.commit_hash }}"
            echo "üìå Hash fourni: $HASH"
          else
            cd iic_demo
            HASH=$(git rev-parse HEAD)
            echo "üìå Hash branch dev: $HASH"
          fi
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - run: pip install requests

      - name: Auth IICS DEV
        env:
          IICS_USERNAME: ${{ secrets.IICS_DEV_USERNAME }}
          IICS_PASSWORD: ${{ secrets.IICS_DEV_PASSWORD }}
          IICS_LOGIN_URL: ${{ env.IICS_LOGIN_URL }}
        run: python scripts/iics_auth.py

      # ‚úÖ CONTR√îLE : V√©rifier commit existe + tag "deploy"
      - name: V√©rifier commit IDMC + tag "deploy"
        env:
          sessionId: ${{ env.sessionId }}
          POD_URL: ${{ env.IICS_DEV_POD_URL }}
          COMMIT_HASH: ${{ steps.get_hash.outputs.hash }}
        run: |
          echo "üîç V√©rification commit $COMMIT_HASH dans IDMC DEV..."
          
          # GET /commit/{hash} pour r√©cup√©rer d√©tails
          RESP=$(curl -sS -w "\n%{http_code}" -X GET "$POD_URL/public/core/v3/commit/$COMMIT_HASH" \
            -H "INFA-SESSION-ID: $sessionId" \
            -H "Accept: application/json")
          
          STATUS=$(echo "$RESP" | tail -n1)
          BODY=$(echo "$RESP" | head -n-1)
          
          if [[ "$STATUS" != "200" ]]; then
            echo "‚ùå ABORT: Commit $COMMIT_HASH introuvable dans IDMC DEV"
            echo "   D√©tails: $BODY"
            echo "   ‚Üí Faites Check-in + Push + Pull dans IDMC DEV"
            exit 1
          fi
          
          # Extraire commitMessage (contient tag)
          TAG=$(echo "$BODY" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('commitMessage',''))")
          
          echo "üìå Commit trouv√©: $COMMIT_HASH"
          echo "üìå Message/Tag IDMC: '$TAG'"
          
          # V√©rifier "deploy" pr√©sent
          if [[ ! "$TAG" =~ deploy ]]; then
            echo "‚ùå ABORT: Commit message doit contenir 'deploy'"
            echo "   Actuel: '$TAG'"
            echo "   ‚Üí Check-in avec Commit Tag contenant 'deploy'"
            exit 1
          fi
          
          echo "‚úÖ Commit valid√© : message contient 'deploy'"

  # ========== JOB 2 : Deploy UAT (KB Informatica Method) ==========
  deploy_uat:
    name: Deploy to UAT
    needs: validate_dev
    runs-on: ubuntu-latest
    environment: UAT
    
    steps:
      - name: Checkout Pipeline
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - run: pip install requests

      - name: Auth IICS UAT
        env:
          IICS_USERNAME: ${{ secrets.IICS_UAT_USERNAME }}
          IICS_PASSWORD: ${{ secrets.IICS_UAT_PASSWORD }}
          IICS_LOGIN_URL: ${{ env.IICS_LOGIN_URL }}
        run: python scripts/iics_auth.py

      # üöÄ Deploy via pullByCommitHash (KB Informatica)
      - name: Pull commit to UAT (pullByCommitHash)
        env:
          sessionId: ${{ env.sessionId }}
          POD_URL: ${{ env.IICS_UAT_POD_URL }}
          COMMIT_HASH: ${{ needs.validate_dev.outputs.commit_hash }}
        run: |
          echo "üöÄ Deploy commit $COMMIT_HASH vers UAT..."
          
          # POST /pullByCommitHash
          RESP=$(curl -sS -w "\n%{http_code}" -X POST "$POD_URL/public/core/v3/pullByCommitHash" \
            -H "INFA-SESSION-ID: $sessionId" \
            -H "Content-Type: application/json" \
            -d "{\"commitHash\":\"$COMMIT_HASH\"}")
          
          STATUS=$(echo "$RESP" | tail -n1)
          BODY=$(echo "$RESP" | head -n-1)
          
          if [[ "$STATUS" == "200" || "$STATUS" == "202" ]]; then
            echo "‚úÖ Pull lanc√© vers UAT"
            echo "$BODY"
            
            # Extraire pullActionId
            PULL_ID=$(echo "$BODY" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('pullActionId',''))")
            echo "PULL_ACTION_ID=$PULL_ID" >> $GITHUB_ENV
          else
            echo "‚ùå Erreur pull UAT: $STATUS"
            echo "$BODY"
            exit 1
          fi

      # üîÑ Attendre fin Pull UAT
      - name: Wait for UAT pull completion
        env:
          sessionId: ${{ env.sessionId }}
          POD_URL: ${{ env.IICS_UAT_POD_URL }}
          PULL_ACTION_ID: ${{ env.PULL_ACTION_ID }}
        run: |
          echo "‚è≥ Attente fin pull UAT (ID: $PULL_ACTION_ID)..."
          
          STATE="IN_PROGRESS"
          RETRY=0
          MAX_RETRY=20
          
          while [[ "$STATE" == "IN_PROGRESS" && $RETRY -lt $MAX_RETRY ]]; do
            sleep 10
            RETRY=$((RETRY+1))
            
            RESP=$(curl -sS -X GET "$POD_URL/public/core/v3/sourceControlAction/$PULL_ACTION_ID" \
              -H "INFA-SESSION-ID: $sessionId")
            
            STATE=$(echo "$RESP" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('status',{}).get('state',''))")
            echo "üìä Pull status: $STATE (tentative $RETRY/$MAX_RETRY)"
          done
          
          if [[ "$STATE" != "SUCCESSFUL" ]]; then
            echo "‚ùå Pull UAT √©chou√©: $STATE"
            exit 1
          fi
          
          echo "‚úÖ Pull UAT termin√© avec succ√®s !"

      # ‚úÖ Test Mapping Tasks (optionnel - KB Informatica)
      - name: Test Mapping Tasks UAT (optionnel)
        if: false  # Mettre 'true' pour activer tests auto
        env:
          sessionId: ${{ env.sessionId }}
          POD_URL: ${{ env.IICS_UAT_POD_URL }}
          COMMIT_HASH: ${{ needs.validate_dev.outputs.commit_hash }}
        run: |
          echo "üß™ Test Mapping Tasks commit $COMMIT_HASH..."
          
          # GET /commit/{hash} pour lister objets
          RESP=$(curl -sS -X GET "$POD_URL/public/core/v3/commit/$COMMIT_HASH" \
            -H "INFA-SESSION-ID: $sessionId")
          
          # Extraire Mapping Tasks (type=MTT)
          python3 << 'PYEOF'
          import json, os, sys, requests, time
          
          resp = json.loads('''$RESP''')
          tasks = [x for x in resp.get('changes', []) if x.get('type') == 'MTT']
          
          if not tasks:
              print("‚ÑπÔ∏è  Aucun Mapping Task √† tester")
              sys.exit(0)
          
          pod = os.environ['POD_URL']
          session = os.environ['sessionId']
          headers = {'INFA-SESSION-ID': session, 'Content-Type': 'application/json'}
          
          for task in tasks:
              task_id = task.get('appContextId')
              task_name = task.get('name', task_id)
              
              print(f"üß™ Test: {task_name}")
              
              # Run job
              body = {'type': 'job', 'taskId': task_id, 'taskType': 'MTT'}
              r = requests.post(f"{pod}/api/v2/job", headers=headers, json=body)
              
              if r.status_code != 200:
                  print(f"‚ùå √âchec d√©marrage: {r.text}")
                  sys.exit(1)
              
              run_id = r.json().get('runId')
              
              # Wait for completion
              state = 0
              retry = 0
              while state == 0 and retry < 30:
                  time.sleep(10)
                  retry += 1
                  a = requests.get(f"{pod}/api/v2/activity/activityLog?runId={run_id}&taskId={task_id}", headers=headers)
                  logs = a.json()
                  if logs:
                      state = logs[0].get('state', 0)
              
              if state != 1:
                  print(f"‚ùå {task_name} √©chou√© (state={state})")
                  sys.exit(1)
              
              print(f"‚úÖ {task_name} OK")
          
          print("‚úÖ Tous les tests UAT OK !")
          PYEOF

      - name: Success
        run: |
          echo "üéâ =========================================="
          echo "üéâ Deploy DEV ‚Üí UAT termin√© avec succ√®s !"
          echo "üéâ Commit: ${{ needs.validate_dev.outputs.commit_hash }}"
          echo "üéâ =========================================="
