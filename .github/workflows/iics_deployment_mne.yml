name: IICS CICD - Test DEV

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Manuel
    inputs:
      tag:  # ✅ CHAMP TAG RETOURNÉ
        description: 'Tag/commit à déployer (ex: v1.0 ou hash)'
        required: true
        default: 'dev'
      environment:
        description: 'DEV/UAT'
        required: false
        default: 'DEV'

env:
  IICS_LOGIN_URL: https://dm-em.informaticacloud.com
  IICS_DEV_POD_URL: https://dm-em.informaticacloud.com/saas
  IICS_UAT_POD_URL: https://emw1.dm-em.informaticacloud.com/saas

jobs:
  Test-DEV:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'DEV' }}
    steps:
    - uses: actions/checkout@v4
      with:
        repository: marouanprojet-ux/IICS_CICD_PIPELINE

    - uses: actions/checkout@v4
      with:
        repository: marouanprojet-ux/iic_demo
        ref: ${{ github.event.inputs.tag || 'dev' }}  # ✅ Tag/branch input
        path: iic_demo

    # ✅ FIX HASH iic_demo (pas pipeline)
    - name: Get REAL iic_demo hash
      id: hash
      run: |
        cd iic_demo
        COMMIT=$(git rev-parse HEAD)
        echo "hash=$COMMIT" >> $GITHUB_OUTPUT

    - uses: actions/setup-python@v5
      with:
        python-version: 3.9

    - run: pip install requests

    - name: IICS Auth
      env:
        IICS_USERNAME: ${{ secrets.IICS_DEV_USERNAME }}
        IICS_PASSWORD: ${{ secrets.IICS_DEV_PASSWORD }}
        IICSPOD_URL: ${{ env.IICS_DEV_POD_URL }}
        COMMITHASH: ${{ steps.hash.outputs.hash }}  # ✅ BON HASH
      run: python scripts/iics_auth.py

    - name: Deploy DEV
      env:
        sessionId: ${{ env.sessionId }}
        IICSPOD_URL: ${{ env.IICS_DEV_POD_URL }}
        COMMITHASH: ${{ steps.hash.outputs.hash }}  # ✅ FIX 404
      run: python scripts/deploy_dev.py

    - name: Success
      run: echo "✅ DEV Deploy OK - hash: ${{ steps.hash.outputs.hash }}"
