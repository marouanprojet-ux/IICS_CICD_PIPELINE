name: IICS CICD - DEV Deploy

on:
  push:
    branches: [ main ]  # Pipeline repo
  workflow_dispatch:

env:
  IICS_LOGIN_URL: https://dm-em.informaticacloud.com
  IICS_DEV_POD_URL: https://dm-em.informaticacloud.com/saas
  IICS_UAT_POD_URL: https://emw1.dm-em.informaticacloud.com/saas

jobs:
  Test-DEV:
    runs-on: ubuntu-24.04
    environment: DEV
    steps:
    # Checkout pipeline repo
    - uses: actions/checkout@v4
      with:
        repository: marouanprojet-ux/IICS_CICD_PIPELINE

    # ✅ FIX: Checkout iic_demo + get REAL hash
    - name: Checkout iic_demo dev
      uses: actions/checkout@v4
      with:
        repository: marouanprojet-ux/iic_demo
        ref: dev
        path: iic_demo

    - name: Get iic_demo commit hash  # ✅ CRITIQUE
      id: gethash
      run: |
        cd iic_demo
        COMMIT=$(git rev-parse HEAD)
        echo "commit_hash=$COMMIT" >> $GITHUB_OUTPUT
        echo "COMMITHASH=$COMMIT" >> $GITHUB_ENV
        echo "✅ iic_demo/dev hash: $COMMIT"

    - name: Setup Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: 3.9

    - name: Install dependencies
      run: pip install requests

    # Auth IICS DEV
    - name: IICS Auth DEV
      id: auth
      env:
        IICS_USERNAME: ${{ secrets.IICS_DEV_USERNAME }}
        IICS_PASSWORD: ${{ secrets.IICS_DEV_PASSWORD }}
        IICSPOD_URL: ${{ env.IICS_DEV_POD_URL }}
      run: python scripts/iics_auth.py

    # ✅ Deploy avec BON hash iic_demo
    - name: Deploy DEV
      env:
        sessionId: ${{ steps.auth.outputs.sessionId }}
        IICSPOD_URL: ${{ env.IICS_DEV_POD_URL }}
        COMMITHASH: ${{ steps.gethash.outputs.commit_hash }}  # ✅ FIX AUTO
      run: python scripts/deploy_dev.py

    # Pull (prochaine étape après check OK)
    - name: Pull commit to DEV
      env:
        sessionId: ${{ steps.auth.outputs.sessionId }}
        IICSPOD_URL: ${{ env.IICS_DEV_POD_URL }}
      run: |
        curl -X POST "${{ env.IICS_DEV_POD_URL }}/public/core/v3/pullByCommitHash" \
          -H "INFA-SESSION-ID: ${{ steps.auth.outputs.sessionId }}" \
          -H "Content-Type: application/json" \
          -d '{"commitHash": "${{ steps.gethash.outputs.commit_hash }}"}'

  Deploy-UAT:
    needs: Test-DEV
    runs-on: ubuntu-24.04
    if: github.ref == 'refs/heads/main'
    environment: UAT
    steps:
      # Même logique UAT...
      - name: IICS Auth UAT
        env:
          IICS_USERNAME: ${{ secrets.IICS_UAT_USERNAME }}
          IICS_PASSWORD: ${{ secrets.IICS_UAT_PASSWORD }}
          IICSPOD_URL: ${{ env.IICS_UAT_POD_URL }}
          COMMITHASH: ${{ needs.Test-DEV.outputs.iic_demo_hash }}
        run: python scripts/iics_auth.py
